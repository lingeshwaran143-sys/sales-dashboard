<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Dashboard - Upload Excel</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#f6f8fb;--card:#ffffff;--accent:#2563eb;--muted:#6b7280}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);padding:18px}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:20px}
    .controls{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(15,23,42,0.06)}
    .upload-row{display:flex;gap:12px;align-items:center}
    input[type=file]{padding:6px}
    .filters{display:flex;gap:12px;margin-top:12px}
    select{padding:8px;border-radius:8px;border:1px solid #e5e7eb}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:14px;margin-top:16px}
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .chart-wrap{height:320px}
    .list-top10{max-height:320px;overflow:auto;margin-top:8px}
    table{width:100%;border-collapse:collapse}
    td,th{padding:6px;border-bottom:1px solid #f1f5f9;font-size:13px}
    .muted{color:var(--muted)}
    .small{font-size:13px}
    .kpi-row{display:flex;gap:12px;margin-top:10px}
    .kpi{flex:1;padding:10px;border-radius:8px;background:#fff;box-shadow:0 1px 3px rgba(2,6,23,0.04)}
    .download-sample{background:transparent;border:1px dashed #cbd5e1;padding:8px;border-radius:8px;cursor:pointer}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}.charts-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Sales Dashboard (HTML / CSS / JS)</h1>
      <div class="muted small">Upload Excel with columns: <strong>State</strong>, <strong>District</strong>, <strong>Style</strong>, <strong>Product Category</strong>, <strong>Sale Order Qty</strong>, <strong>Delivered Qty</strong></div>
    </header>

    <div class="card">
      <div class="upload-row">
        <input id="fileInput" type="file" accept=".xls,.xlsx,.csv" />
        <button class="download-sample" id="downloadSample">Download sample template</button>
        <div style="margin-left:auto" class="muted small">Tip: column names are case-insensitive. Numeric columns should contain numbers.</div>
      </div>

      <div class="filters" style="margin-top:14px">
        <div>
          <label class="small muted">State</label><br>
          <select id="stateFilter"><option value="">(All)</option></select>
        </div>
        <div>
          <label class="small muted">District</label><br>
          <select id="districtFilter"><option value="">(All)</option></select>
        </div>
        <div>
          <label class="small muted">Product Category</label><br>
          <select id="productFilter"><option value="">(All)</option></select>
        </div>
        <div style="margin-left:auto;display:flex;align-items:end">
          <button id="resetBtn" class="download-sample">Reset Filters</button>
        </div>
      </div>

      <div class="kpi-row">
        <div class="kpi">
          <div class="muted small">Total Sale Order Qty (filtered)</div>
          <div id="totSale" style="font-weight:700;font-size:18px">0</div>
        </div>
        <div class="kpi">
          <div class="muted small">Total Delivered Qty (filtered)</div>
          <div id="totDelivered" style="font-weight:700;font-size:18px">0</div>
        </div>
        <div class="kpi">
          <div class="muted small">District contribution to overall Sale Order Qty</div>
          <div id="districtContribution" style="font-weight:700;font-size:18px">0%</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="card" style="margin-bottom:14px">
          <h3 style="margin:0 0 10px 0;font-size:16px">Sale Order vs Delivered</h3>
          <div class="chart-wrap"><canvas id="soVsDelChart"></canvas></div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3 style="margin:0 0 10px 0;font-size:16px">Top 10 Styles (by Sale Order Qty)</h3>
          <div class="chart-wrap"><canvas id="topStylesChart"></canvas></div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3 style="margin:0 0 10px 0;font-size:16px">Product Category Contribution (in selected District)</h3>
          <div class="chart-wrap"><canvas id="prodContribChart"></canvas></div>
          <div class="small muted" style="margin-top:8px">If no district selected, shows contribution across all data.</div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3 style="margin:0 0 8px 0;font-size:16px">Data Preview (first 50 rows)</h3>
          <div class="list-top10"><table id="previewTable"><thead><tr><th>State</th><th>District</th><th>Style</th><th>Product Category</th><th>Sale Order Qty</th><th>Delivered Qty</th></tr></thead><tbody></tbody></table></div>
        </div>
      </div>
    </div>

    <footer>Built with plain HTML/CSS/JS + SheetJS + Chart.js. Open the HTML file in your browser, upload an Excel (.xlsx) file and use the filters.</footer>
  </div>

<script>
// Helper: normalize header names
const HEADER_MAP = {
  'state':'state',
  'district':'district',
  'style':'style',
  'product category':'product_category',
  'productcategory':'product_category',
  'product_group':'product_category',
  'category':'product_category',
  'sale order qty':'sale_order_qty',
  'saleorderqty':'sale_order_qty',
  'sale_order_qty':'sale_order_qty',
  'delivered qty':'delivered_qty',
  'deliveredqty':'delivered_qty',
  'delivered_qty':'delivered_qty'
}

let rawData = []; // array of rows as objects
let charts = {};

function downloadSample(){
  // create CSV sample
  const headers = ['State','District','Style','Product Category','Sale Order Qty','Delivered Qty'];
  const rows = [ ['Tamil Nadu','Ambur','Style A','Kurti',120,100], ['Tamil Nadu','Ambur','Style B','Kurti',80,70], ['Karnataka','Bengaluru','Style C','Saree',150,140] ];
  let csv = headers.join(',') + '\n' + rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='sample_template.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function parseFile(file){
  const reader = new FileReader();
  reader.onload = function(e){    
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data,{type:'array'});
    const first = workbook.SheetNames[0];
    const sheet = workbook.Sheets[first];
    let json = XLSX.utils.sheet_to_json(sheet,{defval: ''});
    if(json.length===0){ alert('No data found in sheet'); return; }

    // normalize headers by mapping keys
    const normalized = json.map(row=>{
      const out = {};
      for(const k of Object.keys(row)){
        const kn = k.toString().trim().toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9]/g,'');
        const mapKey = Object.keys(HEADER_MAP).find(h=>h.replace(/\s+/g,'').toLowerCase()===kn) || null;
        const outKey = mapKey ? HEADER_MAP[mapKey] : null;
        if(outKey){ out[outKey] = row[k]; }
      }
      return out;
    });

    // validate presence of required fields
    const sample = normalized[0];
    const required = ['state','district','style','product_category','sale_order_qty','delivered_qty'];
    const missing = required.filter(r=>!(r in sample));
    if(missing.length){
      // try a more permissive mapping (case-insensitive keys)
      // final fallback: attempt to find columns by fuzzy match
      // For simplicity, warn user
      alert('Could not find all required columns. Please ensure your file has headers named: State, District, Style, Product Category, Sale Order Qty, Delivered Qty (case-insensitive).');
      rawData = [];
      return;
    }

    // convert numeric columns
    rawData = normalized.map(r=>({
      state: String(r.state).trim(),
      district: String(r.district).trim(),
      style: String(r.style).trim(),
      product_category: String(r.product_category).trim(),
      sale_order_qty: Number(r.sale_order_qty) || 0,
      delivered_qty: Number(r.delivered_qty) || 0
    }));

    populateFilters();
    updatePreview();
    updateAllDisplays();
  };
  reader.readAsArrayBuffer(file);
}

function populateFilters(){
  const states = Array.from(new Set(rawData.map(r=>r.state))).sort();
  const districts = Array.from(new Set(rawData.map(r=>r.district))).sort();
  const products = Array.from(new Set(rawData.map(r=>r.product_category))).sort();

  const sSel = document.getElementById('stateFilter'); sSel.innerHTML = '<option value="">(All)</option>' + states.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
  const dSel = document.getElementById('districtFilter'); dSel.innerHTML = '<option value="">(All)</option>' + districts.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
  const pSel = document.getElementById('productFilter'); pSel.innerHTML = '<option value="">(All)</option>' + products.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
}

function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function getFilteredData(){
  const state = document.getElementById('stateFilter').value;
  const district = document.getElementById('districtFilter').value;
  const product = document.getElementById('productFilter').value;
  return rawData.filter(r=>{
    if(state && r.state!==state) return false;
    if(district && r.district!==district) return false;
    if(product && r.product_category!==product) return false;
    return true;
  });
}

function updatePreview(){
  const tbody = document.querySelector('#previewTable tbody'); tbody.innerHTML='';
  const rows = rawData.slice(0,50);
  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(r.state)}</td><td>${escapeHtml(r.district)}</td><td>${escapeHtml(r.style)}</td><td>${escapeHtml(r.product_category)}</td><td>${r.sale_order_qty}</td><td>${r.delivered_qty}</td>`;
    tbody.appendChild(tr);
  }
}

function aggregateTotals(data){
  const totSale = data.reduce((s,r)=>s + Number(r.sale_order_qty||0),0);
  const totDel = data.reduce((s,r)=>s + Number(r.delivered_qty||0),0);
  return {totSale, totDel};
}

function updateAllDisplays(){
  const filtered = getFilteredData();
  const totals = aggregateTotals(filtered);
  document.getElementById('totSale').innerText = formatNumber(totals.totSale);
  document.getElementById('totDelivered').innerText = formatNumber(totals.totDel);

  // district contribution: if a single district selected, compute its sale as % of overall sale
  const district = document.getElementById('districtFilter').value;
  const overallSale = aggregateTotals(rawData).totSale || 1;
  let contribution = 0;
  if(district){
    const distSale = aggregateTotals(rawData.filter(r=>r.district===district)).totSale;
    contribution = overallSale? (distSale / overallSale * 100) : 0;
  } else if(document.getElementById('stateFilter').value){
    // if state selected but not district, compute state's contribution
    const state = document.getElementById('stateFilter').value;
    const stateSale = aggregateTotals(rawData.filter(r=>r.state===state)).totSale;
    contribution = overallSale? (stateSale / overallSale * 100) : 0;
  } else {
    contribution = 100; // whole dataset
  }
  document.getElementById('districtContribution').innerText = contribution.toFixed(2) + '%';

  updateSoVsDelChart(filtered);
  updateTopStylesChart(filtered);
  updateProdContribChart(filtered);
}

function formatNumber(n){ return n.toLocaleString(); }

// Chart builders
function updateSoVsDelChart(data){
  // show totals per product category (or overall) - user wanted sale order qty & delivered qty like chart
  // We'll show aggregated by product category if product filter is not selected; otherwise show a single bar of totals
  const productFilter = document.getElementById('productFilter').value;
  let labels=[], saleData=[], delData=[];

  if(!productFilter){
    const map = {};
    for(const r of data){
      const k = r.product_category || '(Unknown)';
      map[k] = map[k] || {sale:0,del:0}; map[k].sale += r.sale_order_qty; map[k].del += r.delivered_qty;
    }
    const entries = Object.entries(map).sort((a,b)=>b[1].sale - a[1].sale);
    labels = entries.map(e=>e[0]); saleData = entries.map(e=>e[1].sale); delData = entries.map(e=>e[1].del);
  } else {
    const totals = aggregateTotals(data);
    labels = ['Selected']; saleData=[totals.totSale]; delData=[totals.totDel];
  }

  const ctx = document.getElementById('soVsDelChart').getContext('2d');
  if(charts.soVsDelChart) charts.soVsDelChart.destroy();
  charts.soVsDelChart = new Chart(ctx,{
    type:'bar',
    data:{labels, datasets:[{label:'Sale Order Qty',data:saleData,backgroundColor:'rgba(37,99,235,0.8)'},{label:'Delivered Qty',data:delData,backgroundColor:'rgba(16,185,129,0.8)'}]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},scales:{y:{beginAtZero:true}}
    }
  });
}

function updateTopStylesChart(data){
  // aggregate by style, take top 10 by sale order qty
  const map = {};
  for(const r of data){
    const k = r.style || '(Unknown)';
    map[k] = map[k] || 0; map[k] += r.sale_order_qty;
  }
  const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const labels = entries.map(e=>e[0]);
  const values = entries.map(e=>e[1]);
  const ctx = document.getElementById('topStylesChart').getContext('2d');
  if(charts.topStylesChart) charts.topStylesChart.destroy();
  charts.topStylesChart = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Sale Order Qty',data:values,backgroundColor:'rgba(59,130,246,0.85)'}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{beginAtZero:true}}}});
}

function updateProdContribChart(filteredData){
  // product group contribution within selected district (or across all if none selected)
  const district = document.getElementById('districtFilter').value;
  let data = filteredData;
  if(district){
    data = rawData.filter(r=>r.district===district);
  }
  const map = {};
  for(const r of data){ const k=r.product_category||'(Unknown)'; map[k]=map[k]||0; map[k]+=r.sale_order_qty; }
  const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
  const labels = entries.map(e=>e[0]);
  const values = entries.map(e=>e[1]);
  const ctx = document.getElementById('prodContribChart').getContext('2d');
  if(charts.prodContribChart) charts.prodContribChart.destroy();
  charts.prodContribChart = new Chart(ctx,{type:'pie',data:{labels,datasets:[{data:values}]},options:{responsive:true,maintainAspectRatio:false}});
}

// Event wiring
document.getElementById('fileInput').addEventListener('change', (ev)=>{
  const f = ev.target.files[0]; if(!f) return; parseFile(f);
});
document.getElementById('downloadSample').addEventListener('click', downloadSample);
['stateFilter','districtFilter','productFilter'].forEach(id=>document.getElementById(id).addEventListener('change', ()=>{ updateAllDisplays(); }));
document.getElementById('resetBtn').addEventListener('click', ()=>{ document.getElementById('stateFilter').value=''; document.getElementById('districtFilter').value=''; document.getElementById('productFilter').value=''; updateAllDisplays(); });

// initial empty charts
function initEmptyCharts(){
  charts.soVsDelChart = new Chart(document.getElementById('soVsDelChart').getContext('2d'),{type:'bar',data:{labels:['No data'],datasets:[{label:'Sale Order Qty',data:[0]},{label:'Delivered Qty',data:[0]}]},options:{responsive:true,maintainAspectRatio:false}});
  charts.topStylesChart = new Chart(document.getElementById('topStylesChart').getContext('2d'),{type:'bar',data:{labels:[],datasets:[{label:'Sale Order Qty',data:[]}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false}});
  charts.prodContribChart = new Chart(document.getElementById('prodContribChart').getContext('2d'),{type:'pie',data:{labels:[],datasets:[{data:[]}]},options:{responsive:true,maintainAspectRatio:false}});
}
    // =============================
// AUTOLOAD DEFAULT CSV ON PAGE LOAD
// =============================
window.addEventListener("DOMContentLoaded", () => {
  fetch("default_data.csv")
    .then(response => {
      if (!response.ok) throw new Error("No default_data.csv found");
      return response.text();
    })
    .then(csvText => {
      // parse CSV text to JSON similar to Excel handling
      const rows = csvText.trim().split("\n");
      const headers = rows[0].split(",").map(h => h.trim().toLowerCase());
      const data = rows.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h, i) => {
          const key = HEADER_MAP[h] || h.replace(/\s+/g, "_");
          obj[key] = values[i] ? values[i].trim() : "";
        });
        return obj;
      });

      // convert numeric columns
      rawData = data.map(r => ({
        state: String(r.state || "").trim(),
        district: String(r.district || "").trim(),
        style: String(r.style || "").trim(),
        product_category: String(r.product_category || "").trim(),
        sale_order_qty: Number(r.sale_order_qty) || 0,
        delivered_qty: Number(r.delivered_qty) || 0
      }));

      console.log("✅ Default CSV loaded successfully with " + rawData.length + " records.");

      populateFilters();
      updatePreview();
      updateAllDisplays();
    })
    .catch(err => console.warn("⚠️ No default CSV found:", err));
});
initEmptyCharts();


</script>
</body>
</html>




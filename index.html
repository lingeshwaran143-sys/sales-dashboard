<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Dashboard - Auto Load + Upload Excel</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--accent:#2563eb;--muted:#6b7280}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);padding:18px}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:20px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(15,23,42,0.06)}
    .upload-row{display:flex;gap:12px;align-items:center}
    input[type=file]{padding:6px}
    select{padding:8px;border-radius:8px;border:1px solid #e5e7eb}
    .filters{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:14px;margin-top:16px}
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .chart-wrap{height:320px}
    table{width:100%;border-collapse:collapse}
    td,th{padding:6px;border-bottom:1px solid #f1f5f9;font-size:13px}
    .muted{color:var(--muted)} .small{font-size:13px}
    .kpi-row{display:flex;gap:12px;margin-top:10px;flex-wrap:wrap}
    .kpi{flex:1;min-width:180px;padding:10px;border-radius:8px;background:#fff;box-shadow:0 1px 3px rgba(2,6,23,0.04)}
    .download-sample{background:transparent;border:1px dashed #cbd5e1;padding:8px;border-radius:8px;cursor:pointer}
    @media(max-width:900px){.grid{grid-template-columns:1fr}.charts-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>NaiduHall Sales Dashboard FY 24-25 & FY Apr-25 to Sep-25</h1>
    <div class="muted small">Upload or auto-load Excel with: Year, State, District, Style, Product Category, Sale Order Qty, Delivered Qty</div>
  </header>

  <div class="card">
    <div class="upload-row">
      <input id="fileInput" type="file" accept=".xls,.xlsx,.csv" />
      <button id="downloadSample" class="download-sample">Download sample template</button>
    </div>

    <div class="filters">
      <div><label class="small muted">Year</label><br><select id="yearFilter"><option value="">(All)</option></select></div>
      <div><label class="small muted">State</label><br><select id="stateFilter"><option value="">(All)</option></select></div>
      <div><label class="small muted">District</label><br><select id="districtFilter"><option value="">(All)</option></select></div>
      <div><label class="small muted">Product Category</label><br><select id="productFilter"><option value="">(All)</option></select></div>
      <div style="margin-left:auto;display:flex;align-items:end"><button id="resetBtn" class="download-sample">Reset Filters</button></div>
    </div>

    <div class="kpi-row">
      <div class="kpi"><div class="muted small">Total Sale Order Qty</div><div id="totSale" style="font-weight:700;font-size:18px">0</div></div>
      <div class="kpi"><div class="muted small">Total Delivered Qty</div><div id="totDelivered" style="font-weight:700;font-size:18px">0</div></div>
      <div class="kpi"><div class="muted small">District contribution</div><div id="districtContribution" style="font-weight:700;font-size:18px">0%</div></div>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h3 style="margin:0 0 10px 0">Sale Order vs Delivered</h3>
        <div class="chart-wrap"><canvas id="soVsDelChart"></canvas></div>
      </div>
      <div class="card" style="margin-top:14px">
        <h3 style="margin:0 0 10px 0">Top 10 Styles</h3>
        <div class="chart-wrap"><canvas id="topStylesChart"></canvas></div>
      </div>
      
    </div>
    <div>
      <div class="card">
        <h3 style="margin:0 0 10px 0">Product Contribution</h3>
        <div class="chart-wrap"><canvas id="prodContribChart"></canvas></div>
      </div>
    </div>
  </div>
</div>

<script>
// ===============================
// Configuration + Globals
// ===============================
const HEADER_MAP = {
  'year': 'year','fy': 'year','state': 'state','district': 'district','style': 'style',
  'product category': 'product_category','productcategory': 'product_category',
  'sale order qty': 'sale_order_qty','saleorderqty': 'sale_order_qty',
  'delivered qty': 'delivered_qty','deliveredqty': 'delivered_qty'
};
let rawData = [];
let charts = {};

// ===============================
// Sample Download
// ===============================
function downloadSample(){
  const headers = ['Year','State','District','Style','Product Category','Sale Order Qty','Delivered Qty'];
  const rows = [['2024-25','Tamil Nadu','Ambur','Style A','Kurti',120,100],['2025-26','Karnataka','Bengaluru','Style C','Saree',150,140]];
  const csv = headers.join(',') + '\n' + rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'sample_template.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

// ===============================
// File Upload
// ===============================
function parseFile(file){
  const reader = new FileReader();
  reader.onload = e=>{
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data,{type:'array'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet,{defval:''});
    processData(json);
  };
  reader.readAsArrayBuffer(file);
}

// ===============================
// Process Data (common for upload & fetch)
// ===============================
function processData(json){
  const normalized = json.map(row=>{
    const out = {};
    for(const k in row){
      const clean = k.toString().trim().toLowerCase();
      const mapKey = Object.keys(HEADER_MAP).find(h=>h===clean);
      const outKey = mapKey?HEADER_MAP[mapKey]:clean;
      out[outKey]=row[k];
    }
    return out;
  });

  rawData = normalized.map(r=>({
    year:String(r.year||'').trim(),
    state:String(r.state||'').trim(),
    district:String(r.district||'').trim(),
    style:String(r.style||'').trim(),
    product_category:String(r.product_category||'').trim(),
    sale_order_qty:Number(r.sale_order_qty)||0,
    delivered_qty:Number(r.delivered_qty)||0
  }));

  populateFilters();
  updateAllDisplays();
  updatePreview();
}

// ===============================
// Populate Filters + Displays
// ===============================
function populateFilters(){
  const set = (id, vals)=>{
    document.getElementById(id).innerHTML='<option value="">(All)</option>'+vals.map(v=>`<option>${v}</option>`).join('');
  };
  set('yearFilter',[...new Set(rawData.map(r=>r.year))].filter(Boolean).sort());
  set('stateFilter',[...new Set(rawData.map(r=>r.state))].filter(Boolean).sort());
  set('districtFilter',[...new Set(rawData.map(r=>r.district))].filter(Boolean).sort());
  set('productFilter',[...new Set(rawData.map(r=>r.product_category))].filter(Boolean).sort());
}

function getFilteredData(){
  const y=document.getElementById('yearFilter').value;
  const s=document.getElementById('stateFilter').value;
  const d=document.getElementById('districtFilter').value;
  const p=document.getElementById('productFilter').value;
  return rawData.filter(r=>{
    if(y && r.year!==y) return false;
    if(s && r.state!==s) return false;
    if(d && r.district!==d) return false;
    if(p && r.product_category!==p) return false;
    return true;
  });
}

function updatePreview(){
  const tbody=document.querySelector('#previewTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  rawData.slice(0,50).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.state}</td><td>${r.district}</td><td>${r.style}</td><td>${r.product_category}</td><td>${r.sale_order_qty}</td><td>${r.delivered_qty}</td>`;
    tbody.appendChild(tr);
  });
}

// ===============================
// Charts + KPIs
// ===============================
function aggregateTotals(data){
  return {
    totSale:data.reduce((s,r)=>s+r.sale_order_qty,0),
    totDel:data.reduce((s,r)=>s+r.delivered_qty,0)
  };
}
function updateAllDisplays(){
  const f=getFilteredData();
  const totals=aggregateTotals(f);
  document.getElementById('totSale').innerText=totals.totSale.toLocaleString();
  document.getElementById('totDelivered').innerText=totals.totDel.toLocaleString();

  const dSel=document.getElementById('districtFilter').value;
  const sSel=document.getElementById('stateFilter').value;
  const overall=aggregateTotals(rawData).totSale||1;
  let contrib=100;
  if(dSel){
    contrib=(aggregateTotals(rawData.filter(r=>r.district===dSel)).totSale/overall*100)||0;
  }else if(sSel){
    contrib=(aggregateTotals(rawData.filter(r=>r.state===sSel)).totSale/overall*100)||0;
  }
  document.getElementById('districtContribution').innerText=contrib.toFixed(2)+'%';

  updateSoVsDelChart(f);
  updateTopStylesChart(f);
  updateProdContribChart(f);
}

function updateSoVsDelChart(data){
  const map={};
  for(const r of data){
    const k=r.product_category||'(Unknown)';
    map[k]=map[k]||{sale:0,del:0};
    map[k].sale+=r.sale_order_qty;
    map[k].del+=r.delivered_qty;
  }
  const labels=Object.keys(map);
  const sale=labels.map(l=>map[l].sale);
  const del=labels.map(l=>map[l].del);
  const ctx=document.getElementById('soVsDelChart').getContext('2d');
  if(charts.so) charts.so.destroy();
  charts.so=new Chart(ctx,{type:'bar',data:{labels,datasets:[
    {label:'Sale Order Qty',data:sale,backgroundColor:'rgba(37,99,235,0.8)'},
    {label:'Delivered Qty',data:del,backgroundColor:'rgba(16,185,129,0.8)'}
  ]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});
}
function updateTopStylesChart(data){
  const map={};
  for(const r of data){map[r.style]=map[r.style]||0;map[r.style]+=r.sale_order_qty;}
  const top=Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const ctx=document.getElementById('topStylesChart').getContext('2d');
  if(charts.top) charts.top.destroy();
  charts.top=new Chart(ctx,{type:'bar',data:{labels:top.map(t=>t[0]),datasets:[{label:'Sale Order Qty',data:top.map(t=>t[1]),backgroundColor:'rgba(59,130,246,0.85)'}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{beginAtZero:true}}}});
}
function updateProdContribChart(data){
  const map={};
  for(const r of data){map[r.product_category]=map[r.product_category]||0;map[r.product_category]+=r.sale_order_qty;}
  const ctx=document.getElementById('prodContribChart').getContext('2d');
  if(charts.prod) charts.prod.destroy();
  charts.prod=new Chart(ctx,{type:'pie',data:{labels:Object.keys(map),datasets:[{data:Object.values(map)}]},options:{responsive:true,maintainAspectRatio:false}});
}

// ===============================
// Event Listeners
// ===============================
document.getElementById('fileInput').addEventListener('change',ev=>{
  const f=ev.target.files[0]; if(f) parseFile(f);
});
document.getElementById('downloadSample').addEventListener('click',downloadSample);
['yearFilter','stateFilter','districtFilter','productFilter'].forEach(id=>{
  document.getElementById(id).addEventListener('change',updateAllDisplays);
});
document.getElementById('resetBtn').addEventListener('click',()=>{
  ['yearFilter','stateFilter','districtFilter','productFilter'].forEach(id=>document.getElementById(id).value='');
  updateAllDisplays();
});

// ===============================
// Auto-load default_data.csv
// ===============================
window.addEventListener("DOMContentLoaded",()=>{
  fetch("default_data.csv")
    .then(r=>r.ok?r.text():Promise.reject("No CSV"))
    .then(text=>{
      const rows=text.trim().split("\n");
      const headers=rows[0].split(",").map(h=>h.trim());
      const json=rows.slice(1).map(l=>{
        const vals=l.split(",");
        const o={}; headers.forEach((h,i)=>o[h]=vals[i]);
        return o;
      });
      processData(json);
      console.log("✅ Default CSV loaded with",json.length,"records");
    })
    .catch(e=>console.warn("⚠️ Could not load default CSV:",e));
});
</script>
</body>
</html>
